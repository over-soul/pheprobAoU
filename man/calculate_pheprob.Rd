% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/calculate_pheprob.R
\name{calculate_pheprob}
\alias{calculate_pheprob}
\title{Calculate PheProb (Phenotype Probabilities) using All of Us EHR Data}
\usage{
calculate_pheprob(
  concept_ids,
  person_ids = NULL,
  domains = c("condition", "procedure", "drug", "measurement", "observation"),
  date_range = NULL,
  output_format = "wide",
  output_file = NULL,
  batch_size = 10000,
  progress = TRUE,
  max_iterations = 1000,
  convergence_threshold = 1e-06,
  init_method = "random",
  exclude_concepts = NULL,
  data_validation = TRUE,
  model_diagnostics = TRUE,
  ...
)
}
\arguments{
\item{concept_ids}{A numeric vector of OMOP concept IDs that define the
phenotype of interest.}

\item{person_ids}{A numeric vector of person IDs to include in the analysis.
If NULL (default), includes all available persons in the database.}

\item{domains}{Character vector specifying which OMOP domains to search.
Default: c("condition", "procedure", "drug", "measurement", "observation")}

\item{date_range}{Optional list with 'start' and 'end' dates (Date objects)
to limit the temporal scope of data extraction.}

\item{output_format}{Character string specifying output format:
\itemize{
\item "wide": Returns a wide-format tibble (default)
\item "long": Returns a long-format tibble with person_id, score details
\item "matrix": Returns a matrix with persons as rows, scores as columns
}}

\item{output_file}{Optional file path to save results. Format determined by
file extension (.csv, .rds).}

\item{batch_size}{Integer specifying batch size for processing large datasets
(default: 10000). Larger batches are faster but use more memory.}

\item{progress}{Logical indicating whether to show progress bars (default: TRUE)}

\item{max_iterations}{Maximum EM iterations for binomial mixture model (default: 1000)}

\item{convergence_threshold}{Convergence threshold for EM algorithm (default: 1e-6)}

\item{init_method}{Initialization method for EM: "random", "kmeans", "manual" (default: "random")}

\item{exclude_concepts}{Concept IDs to exclude from total healthcare utilization counts}

\item{data_validation}{Logical indicating whether to perform data quality validation (default: TRUE)}

\item{model_diagnostics}{Logical indicating whether to include model diagnostics (default: TRUE)}

\item{...}{Additional arguments}
}
\value{
A tibble with class "pheprob_results" containing:
\item{person_id}{Person identifier}
\item{pheprob_score}{Phenotype probability P(Y=1|S,C)}
\item{total_codes}{Total healthcare code count (C)}
\item{relevant_codes}{Disease-relevant code count (S)}
\item{success_rate}{S/C ratio}
\item{case_probability}{Posterior probability of being a case}
\item{control_probability}{Posterior probability of being a control}
Plus model metadata and diagnostics as attributes.
}
\description{
Calculates phenotype probabilities using the PheProb binomial mixture model.
PheProb models disease-relevant billing codes as a subset of total healthcare
utilization to provide true phenotype probabilities P(Y=1|S,C) where S is
relevant code count and C is total healthcare utilization.
}
\examples{
\dontrun{
# Basic diabetes phenotyping using condition concepts
diabetes_concepts <- c(201826, 4329847, 9201)  # Type 2 diabetes concepts

# Calculate phenotype probabilities
diabetes_scores <- calculate_pheprob(
  concept_ids = diabetes_concepts,
  progress = TRUE
)

# With date range filtering
recent_diabetes <- calculate_pheprob(
  concept_ids = diabetes_concepts,
  date_range = list(start = as.Date("2020-01-01"), end = Sys.Date())
)

# Export results to CSV
calculate_pheprob(
  concept_ids = diabetes_concepts,
  output_file = "diabetes_pheprob_scores.csv"
)
}
}
